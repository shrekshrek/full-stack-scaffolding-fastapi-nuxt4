# GitLab CI/CD 配置 - 简单部署版本
stages:
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

# 部署到生产环境
deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    # 安装必要工具
    - apk add --no-cache openssh-client curl
    # 设置SSH
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_HOST >> ~/.ssh/known_hosts
  script:
    # SSH到服务器执行部署
    - |
      ssh $DEPLOY_USER@$DEPLOY_HOST "
        cd /app &&
        git pull origin main &&
        # 使用 .env.production 作为变量来源，确保 APP_NAME/PROJECT_NAME 等插值生效
        docker-compose --env-file .env.production -f docker-compose.prod.yml up -d --build &&
        sleep 10 &&
        curl -f http://localhost/health || echo 'Warning: backend health check failed'
      "
  only:
    - main  # 只在main分支触发
  when: manual  # 手动触发部署（可改为自动: 删除此行）
